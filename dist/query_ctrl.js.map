{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","SkydiveDatasourceQueryCtrl","$scope","$injector","uiSegmentSrv","scope","metricType","target","metricField","metricFields","metricTypeFields","dedupFlow","text","value","dedupIntf","dedup","aggregates","mode","prevWorked","prevTitle","prevGremlin","prevMetricField","prevDedup","prevAggregates","prevMode","onChangeInternal","gremlin","range","panelCtrl","query","datasource","targetToQuery","title","q","from","format","to","doGremlinQuery","then","result","status","data","length","_","forEach","metrics","uuid","metric","forOwn","key","k","push","refresh","templateUrl"],"mappings":"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","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nexport class SkydiveDatasourceQueryCtrl extends QueryCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, uiSegmentSrv) {\n    super($scope, $injector);\n\n    this.scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n\n    // set visibility of some field depending on the type of metrics returned\n    this.metricType = 'interface';\n\n    this.target.metricField = this.target.metricField || \"Bytes\";\n\n    this.metricFields = [];\n    this.metricTypeFields = {\n      \"interface\": [\n        'Bytes',\n        'Packets',\n        'Collisions',\n        'Multicast',\n        'RxBytes',\n        'RxCompressed',\n        'RxCrcErrors',\n        'RxDropped',\n        'RxErrors',\n        'RxFifoErrors',\n        'RxFrameErrors',\n        'RxLengthErrors',\n        'RxMissedErrors',\n        'RxOverErrors',\n        'RxPackets',\n        'TxAbortedErrors',\n        'TxBytes',\n        'TxCarrierErrors',\n        'TxCompressed',\n        'TxDropped',\n        'TxErrors',\n        'TxFifoErrors',\n        'TxHeartbeatErrors',\n        'TxPackets',\n        'TxWindowErrors'\n      ],\n      \"flow\": [\n        'Bytes',\n        'Packets',\n        'ABPackets',\n        'ABBytes',\n        'BAPackets',\n        'BABytes'\n      ]\n    };\n\n    this.dedupFlow = [\n      {text: \"---\", value: \"---\"},\n      {text: \"LayersPath\", value: \"LayersPath\"},\n      {text: \"Application\", value: \"Application\"},\n      {text: \"TrackingID\", value: \"TrackingID\"},\n      {text: \"ParentUUID\", value: \"ParentUUID\"},\n      {text: \"NodeTID\", value: \"NodeTID\"},\n      {text: \"ANodeTID\", value: \"ANodeTID\"},\n      {text: \"BNodeTID\", value: \"BNodeTID\"}\n    ];\n\n    this.dedupIntf = [\n      {text: \"---\", value: \"---\"},\n      {text: \"ID\", value: \"ID\"},\n      {text: \"TID\", value: \"TID\"},\n      {text: \"Type\", value: \"Type\"}\n    ];\n\n    this.target.dedup = this.target.dedup || \"---\";\n    this.dedup = this.dedupFlow;\n\n    this.target.aggregates = this.target.aggregates || false;\n\n    this.target.mode = this.target.mode || \"All\";\n    this.mode = [\n      {text: \"All\", value: \"All\"},\n      {text: \"Outer only\", value: \"Outer\"},\n      {text: \"Inner only\", value: \"Inner\"}\n    ];\n\n    this.prevWorked = false;\n    this.prevTitle = \"\";\n    this.prevGremlin = \"\";\n    this.prevMetricField = this.metricField;\n    this.prevDedup = this.dedup;\n    this.prevAggregates = this.aggregates;\n    this.prevMode = this.mode;\n\n    this.onChangeInternal();\n  }\n\n  getCollapsedText() {\n    return this.target.gremlin;\n  }\n\n  onChangeInternal() {\n    var range = this.panelCtrl.range;\n\n    var query = this.datasource.targetToQuery(this.target, 1, 2);\n\n    if (!this.prevWorked || this.prevGremlin !== query.gremlin || this.prevMetricField != this.target.metricField ||\n        this.prevAggregates != this.target.aggregates || this.prevMode != this.target.mode ||\n        this.prevTitle != this.target.title) {\n\n      this.prevWorked = false;\n\n      // flow metrics ?\n      var metricType = this.metricType;\n\n      var target = {\n        gremlin: this.target.gremlin\n      };\n\n      var q = this.datasource.targetToQuery(target, range.from.format('X'), range.to.format('X'));\n      this.datasource.doGremlinQuery(q.gremlin).then(result => {\n        if (result.status === 200 && result.data.length > 0) {\n          this.prevWorked = true;\n\n          this.metricFields = [];\n          this.prevMetricField = this.target.metricField;\n\n          _.forEach(result.data[0], (metrics, uuid) => {\n            _.forEach(metrics, metric => {\n              _.forOwn(metric, (value, key) => {\n                if (key === \"ABBytes\" || key === \"BABytes\") {\n                  metricType = \"flow\";\n                  return false;\n                } else if (key === \"RxPackets\" || key === \"TxPackets\") {\n                  metricType = \"interface\";\n                  return false;\n                }\n              });\n\n              return false;\n            });\n            return false;\n          });\n        }\n\n        for (let k of this.metricTypeFields[metricType]) {\n          this.metricFields.push({text: k, value: k});\n        }\n\n        if (metricType === \"flow\") {\n          this.dedup = this.dedupFlow;\n        } else {\n          this.dedup = this.dedupIntf;\n        }\n        if (this.metricType != metricType) {\n          this.metricType = metricType;\n\n          // reset the metricField as we changed of type of metrics\n          this.target.metricField = \"Bytes\";\n        }\n\n        this.prevTitle = this.target.title;\n        this.prevGremlin = query.gremlin;\n        this.prevMetricField = this.target.metricField;\n        this.prevDedup = this.target.dedup;\n        this.prevAggregates = this.target.aggregates;\n        this.prevMode = this.target.mode;\n\n        this.panelCtrl.refresh();\n      });\n    }\n  }\n}\n\nSkydiveDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"],"file":"query_ctrl.js"}